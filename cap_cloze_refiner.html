<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Path Studio</title>

  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: {
              50: "#eef2ff",
              100: "#e0e7ff",
              200: "#c7d2fe",
              300: "#a5b4fc",
              400: "#818cf8",
              500: "#6366f1",
              600: "#4f46e5",
              700: "#4338ca",
              800: "#3730a3",
              900: "#312e81",
            },
            secondary: {
              50: "#ecfdf5",
              100: "#d1fae5",
              200: "#a7f3d0",
              300: "#6ee7b7",
              400: "#34d399",
              500: "#10b981",
              600: "#059669",
              700: "#047857",
              800: "#065f46",
              900: "#064e3b",
            },
          },
          fontFamily: {
            // Aptos first (Windows 11 / M365). Falls back everywhere else.
            sans: [
              "Aptos",
              "Inter",
              "system-ui",
              "-apple-system",
              "Segoe UI",
              "Roboto",
              "Arial",
              "sans-serif",
            ],
            mono: ["Fira Code", "Consolas", "Monaco", "monospace"],
          },
        },
      },
    };
  </script>

  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap"
    rel="stylesheet"
  />

  <style>
    /* Cursor shape */
    textarea,
    input[type="text"],
    input[type="number"],
    input[type="search"],
    select {
      cursor: text;
    }
    button,
    a,
    label,
    [role="button"] {
      cursor: pointer;
    }
    .bg-decor {
      pointer-events: none;
    }

    /* Caret + text color */
    textarea,
    input[type="text"],
    input[type="number"],
    input[type="search"],
    select {
      caret-color: #000 !important;
      color: #0f172a !important; /* slate-900-ish */
    }

    .dark textarea,
    .dark input,
    .dark select {
      caret-color: #fff !important;
      color: #e2e8f0 !important; /* slate-200 */
    }

    /* âœ… Rewriter preset hover behavior (fixes "white out") */
    .rwPreset:not([aria-pressed="true"]):hover {
      background-color: rgb(241 245 249) !important; /* slate-100 */
    }
    .rwPreset[aria-pressed="true"]:hover {
      filter: brightness(0.95);
    }
  </style>
</head>

<body class="font-sans antialiased min-h-screen p-4 md:p-8 bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-100">
  <div class="bg-decor fixed inset-0 -z-10"></div>

  <div class="max-w-7xl mx-auto bg-white dark:bg-slate-900 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-800 overflow-hidden">

<!-- Header -->
<div class="px-6 py-5 border-b border-slate-100 dark:border-slate-800 bg-gradient-to-r from-slate-50 to-white dark:from-slate-900 dark:to-slate-950 flex justify-between items-center">
  <div class="flex flex-col gap-1">
    <h1 class="flex items-center gap-2 text-2xl font-bold text-slate-900 dark:text-slate-100">
      <span class="text-2xl leading-none" style="font-family:'Segoe UI Emoji','Apple Color Emoji','Noto Color Emoji',sans-serif;">ðŸ”¬</span>
      <span class="text-2xl leading-none" style="font-family:'Segoe UI Emoji','Apple Color Emoji','Noto Color Emoji',sans-serif;">ðŸ§ª</span>
      <span>Path Studio</span>
    </h1>

    <p class="text-sm text-slate-500 dark:text-slate-300">
      A workspace for pathology training, reporting, and study.
    </p>
  </div>

  <div class="flex items-center gap-2">
    <!-- Server badge -->
    <div class="hidden md:flex items-center gap-2 text-xs text-slate-400 dark:text-slate-300 bg-slate-100 dark:bg-slate-800 px-3 py-1.5 rounded-full">
      <span class="w-2 h-2 rounded-full bg-secondary-500 animate-pulse"></span>
      <span id="serverBadge">Server: â€¦</span>
    </div>

    <!-- Dark mode toggle -->
    <button
      id="themeToggle"
      type="button"
      class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-700 transition"
      aria-label="Toggle dark mode"
    >
      <span id="themeIcon">ðŸŒ™</span>
      <span id="themeLabel">Dark</span>
    </button>
  </div>
</div>

<div class="p-6 space-y-6">
  <!-- Tabs -->
  <div class="flex flex-wrap gap-2 border-b border-slate-200 dark:border-slate-800 pb-3">
        <button
      type="button"
      class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold
            bg-slate-100 dark:bg-slate-800
            text-slate-700 dark:text-slate-200
            hover:bg-slate-200 dark:hover:bg-slate-700
            transition-all"
      data-tab="rewriter"
    >
      Rewriter
    </button>

    <button
      type="button"
      class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold
            bg-slate-100 dark:bg-slate-800
            text-slate-700 dark:text-slate-200
            hover:bg-slate-200 dark:hover:bg-slate-700
            transition-all"
      data-tab="refiner"
    >
      Refiner
    </button>

    <button
      type="button"
      class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold
            bg-slate-100 dark:bg-slate-800
            text-slate-700 dark:text-slate-200
            hover:bg-slate-200 dark:hover:bg-slate-700
            transition-all"
      data-tab="synoptic"
    >
      Synoptic
    </button>
  </div>

      <!-- ========================= -->
      <!-- REWRITER PANEL -->
      <!-- ========================= -->
<section
  class="tab-panel hidden rounded-xl p-4
         border border-emerald-500/10 dark:border-emerald-400/10
         bg-gradient-to-br from-emerald-500/10 to-slate-900/10
         dark:from-emerald-400/10 dark:to-slate-950/40"
  data-panel="rewriter"
>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

          <!-- Input -->
          <div class="space-y-3">
          <label class="text-sm font-semibold text-slate-700 dark:text-slate-200">Input</label>

            <textarea
              id="rwInput"
              placeholder="Ask anything or paste textâ€¦"
              class="w-full h-72 px-4 py-3
              bg-slate-50 dark:bg-slate-900
              border border-slate-200 dark:border-slate-700
              rounded-xl font-sans text-[15px] leading-relaxed tracking-tight
              text-slate-900 dark:text-slate-100 placeholder:text-slate-400 dark:placeholder:text-slate-500
              resize-y focus:outline-none focus:ring-2 focus:ring-primary-500
              focus:bg-white dark:focus:bg-slate-900 transition-all"
            ></textarea>

            <div class="flex gap-2">
              <button
                id="rwRun"
                type="button"
                class="inline-flex items-center gap-2 px-4 py-2
                       bg-primary-600 hover:bg-primary-700
                       text-white text-sm font-medium rounded-lg transition-all"
              >
                Send âžœ
              </button>

              <button
                id="rwClear"
                type="button"
                class="inline-flex items-center gap-2 px-4 py-2
                bg-slate-100 hover:bg-slate-200
                dark:bg-slate-800 dark:hover:bg-slate-700
                text-slate-700 dark:text-slate-200
                text-sm font-medium rounded-lg transition-all"
              >
                Clear
              </button>
            </div>

            <div class="flex flex-wrap gap-2">
              <!-- IMPORTANT: no hover:bg-* on these buttons (hover handled in CSS) -->
              <button
                type="button"
                class="rwPreset text-xs px-3 py-1.5 rounded-lg
                border border-slate-200 dark:border-slate-700
                bg-white/70 dark:bg-slate-800/70
                text-slate-700 dark:text-slate-200
                shadow-sm transition-all"
                data-preset="general"
              >
                General
              </button>

              <button
                type="button"
                class="rwPreset text-xs px-3 py-1.5 rounded-lg
                border border-slate-200 dark:border-slate-700
                bg-white/70 dark:bg-slate-800/70
                text-slate-700 dark:text-slate-200
                shadow-sm transition-all"
                data-preset="email"
              >
                Email
              </button>

              <button
                type="button"
                class="rwPreset text-xs px-3 py-1.5 rounded-lg
                border border-slate-200 dark:border-slate-700
                bg-white/70 dark:bg-slate-800/70
                text-slate-700 dark:text-slate-200
                shadow-sm transition-all"
                data-preset="micro"
              >
                Micro
              </button>

              <button
              type="button"
              class="rwPreset text-xs px-3 py-1.5 rounded-lg
              border border-slate-200 dark:border-slate-700
              bg-white/70 dark:bg-slate-800/70
              text-slate-700 dark:text-slate-200
              shadow-sm transition-all"
              data-preset="gross"
            >
              Gross
            </button>

              <button
                type="button"
                class="rwPreset text-xs px-3 py-1.5 rounded-lg
                border border-slate-200 dark:border-slate-700
                bg-white/70 dark:bg-slate-800/70
                text-slate-700 dark:text-slate-200
                shadow-sm transition-all"
                data-preset="path"
              >
                Path
              </button>
            </div>
          </div>

          <!-- Output -->
          <div class="space-y-3">
            <label class="text-sm font-semibold text-slate-700 dark:text-slate-200">Output</label>

            <textarea
              id="rwOutput"
              placeholder="Response will appear hereâ€¦"
              class="w-full h-72 px-4 py-3
              bg-slate-50 dark:bg-slate-900
              border border-slate-200 dark:border-slate-700
              rounded-xl font-sans text-[15px] leading-relaxed tracking-tight
              text-slate-900 dark:text-slate-100 placeholder:text-slate-400 dark:placeholder:text-slate-500
              resize-y focus:outline-none focus:ring-2 focus:ring-primary-500
              focus:bg-white dark:focus:bg-slate-900 transition-all"
            ></textarea>

            <div class="flex justify-end mt-2">
              <button
                id="rwCopy"
                type="button"
                disabled
                class="inline-flex items-center gap-1.5 px-3 py-1.5
                       bg-slate-100 hover:bg-slate-200
                       text-slate-700 text-xs font-medium rounded-lg
                       transition-all disabled:opacity-50"
              >
                Copy
              </button>
            </div>

<div class="flex items-center justify-between">
  <div class="flex items-baseline gap-2">
    <div class="text-sm font-semibold text-slate-700 dark:text-slate-200">
      Rules override
    </div>
    <div class="text-xs text-slate-500 dark:text-slate-400">
      (editable)
    </div>
  </div>

  <!-- IMPORTANT: label wraps the input + track so clicking works -->
<label class="inline-flex items-center gap-2 cursor-pointer select-none">
  <span class="text-[11px] font-medium text-slate-500 dark:text-slate-300">
    Keep Rules
  </span>

  <!-- âœ… explicit size so the invisible input has a real click box -->
  <span class="relative inline-block h-6 w-12">
    <input
      id="rwKeepRules"
      type="checkbox"
      class="peer absolute inset-0 z-10 opacity-0 cursor-pointer"
    />

    <span
      class="absolute inset-0 rounded-full
             bg-slate-200 dark:bg-slate-700
             border border-slate-300 dark:border-slate-600
             transition-colors
             peer-checked:bg-purple-600 peer-checked:border-purple-600"
    >
      <span
        class="absolute top-0.5 left-0.5 h-5 w-5 rounded-full bg-white shadow
               transition-transform
               peer-checked:translate-x-6"
      ></span>
    </span>
  </span>
</label>

</div>

            <textarea
              id="rwRules"
              placeholder="Optional constraints (tone, bullets, length, style)â€¦"
              class="w-full h-40 px-3 py-2
              bg-slate-50 dark:bg-slate-900
              border border-slate-200 dark:border-slate-700
              rounded-xl font-sans text-[15px] leading-relaxed tracking-tight
              text-slate-900 dark:text-slate-100 placeholder:text-slate-400 dark:placeholder:text-slate-500
              resize-y focus:outline-none focus:ring-2 focus:ring-primary-500
              focus:bg-white dark:focus:bg-slate-900 transition-all"
            ></textarea>
          </div>
        </div>
      </section>

      <!-- ========================= -->
      <!-- REFINER PANEL -->
      <!-- ========================= -->
      <section class="tab-panel" data-panel="refiner">

<!-- Toolbar -->
<div
  class="grid grid-cols-1 md:grid-cols-3 gap-4
         bg-slate-50/50 dark:bg-slate-900/40
         p-4 rounded-xl
         border border-slate-100 dark:border-slate-800"
>
  <div class="space-y-1.5">
    <label
      class="text-xs font-semibold text-slate-600 uppercase tracking-wider
             flex items-center gap-1.5 dark:text-slate-100"
    >
      <i data-feather="cpu" class="w-3.5 h-3.5"></i>
      Model
    </label>

    <select
      id="model"
      class="w-full px-3 py-2
             bg-white dark:bg-slate-900
             border border-slate-200 dark:border-slate-700
             rounded-lg text-sm
             text-slate-900 dark:text-slate-100
             focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent
             transition-all"
    >
      <option value="gpt-4.1-mini">gpt-4.1-mini (fast)</option>
      <option value="gpt-4.1">gpt-4.1 (quality)</option>
    </select>
  </div>

  <div class="space-y-1.5">
    <label
      class="text-xs font-semibold text-slate-600 uppercase tracking-wider
             flex items-center gap-1.5 dark:text-slate-100"
    >
      <i data-feather="thermometer" class="w-3.5 h-3.5"></i>
      Temperature
    </label>

    <input
      id="temp"
      type="number"
      step="0.1"
      min="0"
      max="2"
      value="0.2"
      class="w-full px-3 py-2
             bg-white dark:bg-slate-900
             border border-slate-200 dark:border-slate-700
             rounded-lg text-sm
             text-slate-900 dark:text-slate-100
             placeholder:text-slate-400 dark:placeholder:text-slate-500
             focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent
             transition-all cursor-text"
    />
  </div>

  <div class="space-y-1.5">
    <label
      class="text-xs font-semibold text-slate-600 uppercase tracking-wider
             flex items-center gap-1.5 dark:text-slate-100"
    >
      <i data-feather="minus" class="w-3.5 h-3.5"></i>
      ~~Insert Card Break~~
    </label>

    <button
      id="autoInsert"
      type="button"
      class="mt-2 inline-flex items-center gap-4 px-20 py-2.5
       text-xs font-medium
       bg-slate-100 hover:bg-slate-200
       dark:bg-slate-800 dark:hover:bg-slate-700
       text-slate-700 dark:text-slate-200
       rounded-lg transition-all active:scale-95"
    >
      â•¾â•¾â•¾ â—† â•¾â•¾â•¾
    </button>
  </div>
</div>

        <!-- Main Grid background fade -->
                  <div
            class="grid grid-cols-1 lg:grid-cols-2 gap-6 rounded-xl p-4"
            style="
              background: linear-gradient(
                135deg,
                rgba(16, 185, 129, 0.08),
                rgba(30, 41, 59, 0.08)
              );
            "
          >
          <!-- Input -->
          <div class="space-y-3 flex flex-col">
            <div class="flex items-center justify-between">
              <label class="text-sm font-semibold text-slate-700 flex items-center gap-2 dark:text-slate-300">
                <i data-feather="edit-3" class="w-4 h-4 text-primary-600"></i>
                Bulk Input
              </label>
              <span class="text-xs text-slate-400" id="inputStats">0 cards detected</span>
            </div>

            <div class="relative flex-1">
              <textarea
                id="bulkInput"
                placeholder="Card 1 text...

===CARD===

Card 2 text...

===CARD===

Card 3 text..."
                class="w-full h-64 lg:h-80 px-4 py-3
                bg-slate-50 dark:bg-slate-900
                border border-slate-200 dark:border-slate-700
                rounded-xl
                font-mono text-sm leading-relaxed
                text-slate-900 dark:text-slate-100
                placeholder:text-slate-400 dark:placeholder:text-slate-500
                resize-y focus:outline-none focus:ring-2 focus:ring-primary-500
                focus:bg-white dark:focus:bg-slate-900
                transition-all cursor-text"
              ></textarea>

              <div class="absolute bottom-3 right-3 flex gap-2 pointer-events-auto">
                <button id="clear" type="button" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all" title="Clear all">
                  <i data-feather="trash-2" class="w-4 h-4"></i>
                </button>
              </div>
            </div>

            <div class="mt-3">
              <div class="flex items-center justify-between gap-3">
                <label class="text-xs font-semibold text-slate-600 uppercase tracking-wider dark:text-slate-300">
                  Extra Cloze Rules (optional)
                </label>

                <label class="inline-flex items-center gap-2 cursor-pointer select-none">
                  <span class="text-[11px] font-medium text-slate-500 dark:text-slate-300">
                    Keep Rules
                  </span>
                  <input id="rfKeepRules" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500" />
                </label>
              </div>

              <textarea
                id="extraRules"
                placeholder="Example: Prefer numeric anchors like '48 hours'. Do not cloze organism names."
                class="w-full mt-1 h-24 px-3 py-2
                bg-white dark:bg-slate-900
                border border-slate-200 dark:border-slate-700
                rounded-lg text-sm font-mono
                text-slate-900 dark:text-slate-100
                placeholder:text-slate-400 dark:placeholder:text-slate-500
                focus:outline-none focus:ring-2 focus:ring-primary-500
                resize-y"
              ></textarea>
            </div>

            <div class="flex items-center justify-between pt-2">
              <div id="status" class="text-sm text-slate-600 flex items-center gap-2 min-h-[1.5rem]">
                <span class="text-slate-400">Ready to refine</span>
              </div>
              <button
                id="refineAll"
                type="button"
                class="inline-flex items-center gap-2 px-5 py-2.5 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg transform hover:-translate-y-0.5 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
              >
                <i data-feather="zap" class="w-4 h-4"></i>
                Refine All
              </button>
            </div>

            <p class="text-xs text-slate-400">
              Pro tip: Press
              <kbd class="px-1.5 py-0.5 bg-slate-100 dark:bg-slate-800 rounded text-slate-600 dark:text-slate-200 font-mono">Ctrl</kbd> +
              <kbd class="px-1.5 py-0.5 bg-slate-100 dark:bg-slate-800 rounded text-slate-600 dark:text-slate-200 font-mono">Enter</kbd>
            </p>
          </div>

          <!-- Output -->
          <div class="space-y-3 flex flex-col">
            <div class="flex items-center justify-between">
              <label class="text-sm font-semibold text-slate-700 flex items-center gap-2 dark:text-slate-300">
                <i data-feather="check-circle" class="w-4 h-4 text-secondary-600"></i>
                Refined Outputs
              </label>
              <div class="flex gap-2">
                <button
                  id="copyAll"
                  type="button"
                  class="text-xs inline-flex items-center gap-1.5 px-3 py-1.5
                  bg-slate-100 hover:bg-slate-200
                  dark:bg-slate-800 dark:hover:bg-slate-700
                  text-slate-700 dark:text-slate-200
                  rounded-lg transition-colors disabled:opacity-50"
                  disabled
                >
                  <i data-feather="copy" class="w-3.5 h-3.5"></i>
                  Copy All
                </button>
                <button
                  id="downloadAll"
                  type="button"
                  class="text-xs inline-flex items-center gap-1.5 px-3 py-1.5
       bg-secondary-50 hover:bg-secondary-100
       dark:bg-slate-800 dark:hover:bg-slate-700
       text-secondary-700 dark:text-slate-200
       rounded-lg transition-colors disabled:opacity-50"
                  disabled
                >
                  <i data-feather="download" class="w-3.5 h-3.5"></i>
                  Download
                </button>
              </div>
            </div>

            <div id="outputs"
              class="flex-1
                    bg-slate-50 dark:bg-slate-900
                    rounded-xl
                    border border-slate-200 dark:border-slate-700
                    p-4 space-y-3
                    overflow-y-auto
                    max-h-[24rem] lg:max-h-[32rem] min-h-[16rem]"
            >
              <div class="flex flex-col items-center justify-center h-full text-slate-400 space-y-2" id="emptyState">
                <i data-feather="inbox" class="w-12 h-12 opacity-20"></i>
                <p class="text-sm">No refined cards yet</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ========================= -->
      <!-- SYNOPTIC -->
      <!-- ========================= -->
      <section class="tab-panel hidden" data-panel="synoptic">
        <div class="w-full h-[80vh] border border-slate-200 rounded-xl overflow-hidden bg-white">
          <iframe
            src="/cap_synoptic_generator.html"
            class="w-full h-full"
            frameborder="0"
          ></iframe>
        </div>
      </section>

    </div>
  </div>

  <!-- Scripts -->
  <script src="components/output-card.js" defer></script>
  <script src="script.js" defer></script>

<!-- Tabs script (ONE only) -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    if (window.feather) feather.replace();

    // âœ… SET SERVER BADGE DYNAMICALLY
    const sb = document.getElementById("serverBadge");
    if (sb) sb.textContent = `Server: ${window.location.host}`;

    // ============================
    // THEME (Dark Mode) TOGGLE
    // ============================
    const root = document.documentElement; // <html>
    const toggleBtn = document.getElementById("themeToggle");
    const themeIcon = document.getElementById("themeIcon");
    const themeLabel = document.getElementById("themeLabel");

    function applyTheme(mode) {
      const isDark = mode === "dark";
      root.classList.toggle("dark", isDark);
      if (themeIcon) themeIcon.textContent = isDark ? "â˜€ï¸" : "ðŸŒ™";
      if (themeLabel) themeLabel.textContent = isDark ? "Light" : "Dark";
    }

    // Initialize from saved preference, else OS preference
    const saved = localStorage.getItem("theme");
    if (saved === "dark" || saved === "light") {
      applyTheme(saved);
    } else {
      const prefersDark = window.matchMedia?.("(prefers-color-scheme: dark)")?.matches;
      applyTheme(prefersDark ? "dark" : "light");
    }

    if (toggleBtn) {
      toggleBtn.addEventListener("click", () => {
        const next = root.classList.contains("dark") ? "light" : "dark";
        localStorage.setItem("theme", next);
        applyTheme(next);
      });
    }

    // ============================
    // Tabs
    // ============================
    const buttons = document.querySelectorAll(".tab-btn");
    const panels = document.querySelectorAll(".tab-panel");

    function activate(tabName) {
      panels.forEach((p) => p.classList.toggle("hidden", p.dataset.panel !== tabName));
      buttons.forEach((b) => {
        const isActive = b.dataset.tab === tabName;

        // Active state
        b.classList.toggle("bg-primary-600", isActive);
        b.classList.toggle("text-white", isActive);
        b.classList.toggle("ring-2", isActive);
        b.classList.toggle("ring-primary-500/40", isActive);

        // Inactive state
        b.classList.toggle("bg-slate-100", !isActive);
        b.classList.toggle("dark:bg-slate-800", !isActive);
        b.classList.toggle("text-slate-700", !isActive);
        b.classList.toggle("dark:text-slate-200", !isActive);

        // Clean up hover glow on inactive
        if (!isActive) {
          b.classList.remove("ring-2", "ring-primary-500/40", "shadow-lg", "shadow-primary-500/30");
        }
      });

      if (window.feather) feather.replace();
    }

        function clearRefinerTab() {
      bulkInput.value = "";
      if (extraRulesEl) extraRulesEl.value = "";
      renderCards([]);
      refreshStats();
      setStatus("");
    }

    function clearRewriterTab() {
      rwInput.value = "";
      rwRules.value = "";
      rwOutput.value = "";
      rwCopy.disabled = true;
      setStatus("");
    }

    buttons.forEach((btn) => btn.addEventListener("click", () => activate(btn.dataset.tab)));
    activate("rewriter"); // or "refiner" or "synoptic"

    // ============================
    // Enter = Refine | Ctrl/Cmd+Enter = New line
    // bulkInput + extraRules
    // ============================
    document.addEventListener(
      "keydown",
      (e) => {
        const t = e.target;
        if (!(t instanceof HTMLTextAreaElement)) return;
        if (t.id !== "bulkInput" && t.id !== "extraRules") return;

        const isEnter = e.key === "Enter" || e.key === "NumpadEnter";
        if (!isEnter) return;

        const isCtrlOrCmd = e.ctrlKey || e.metaKey;

        // Ctrl/Cmd + Enter â†’ newline
        if (isCtrlOrCmd) {
          e.preventDefault();
          const start = t.selectionStart ?? t.value.length;
          const end = t.selectionEnd ?? t.value.length;
          t.value = t.value.slice(0, start) + "\n" + t.value.slice(end);
          t.selectionStart = t.selectionEnd = start + 1;
          return;
        }

        // Enter â†’ refine
        e.preventDefault();
        if (typeof refineAll === "function") refineAll();
      },
      true
    );
  });
</script>
</body>
</html>
